name: Documentation & Communication

on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - '**.md'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # ==========================================================================
  # DOCUMENTATION BUILD
  # ==========================================================================
  docs-build:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build documentation
        run: |
          # Build documentation site
          npm run docs:build
          
          # Check for broken links
          npm run docs:check-links || true

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/build/
          retention-days: 7

  # ==========================================================================
  # DEPLOY DOCUMENTATION
  # ==========================================================================
  docs-deploy:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: docs-build
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Download documentation artifacts
        uses: actions/download-artifact@v4
        with:
          name: documentation
          path: docs/build/

      - name: Upload to GitHub Pages
        id: deployment
        uses: actions/upload-pages-artifact@v2
        with:
          path: docs/build/

  # ==========================================================================
  # API DOCUMENTATION
  # ==========================================================================
  api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate API docs
        run: |
          # Generate OpenAPI/Swagger documentation
          npm run docs:api
          
          # Validate OpenAPI spec
          npm run docs:api:validate

      - name: Upload API documentation
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: docs/api/
          retention-days: 7

  # ==========================================================================
  # CHANGELOG GENERATION
  # ==========================================================================
  changelog:
    name: Update Changelog
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog
        run: |
          # Generate changelog using conventional commits
          npx conventional-changelog -p angular -i CHANGELOG.md -s
          
          # Commit and push changelog
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for ${{ github.ref_name }}" || exit 0
          git push

  # ==========================================================================
  # README VALIDATION
  # ==========================================================================
  readme-check:
    name: Validate README
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README structure
        run: |
          # Check if README has required sections
          README="README.md"
          
          REQUIRED_SECTIONS=("Installation" "Usage" "API" "Contributing" "License")
          
          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -q "^## $section" "$README"; then
              echo "‚ùå Missing section: $section"
              exit 1
            fi
          done
          
          echo "‚úÖ README has all required sections"

      - name: Check links in README
        run: |
          # Check for broken links in README
          npx markdown-link-check README.md || true

  # ==========================================================================
  # COMMUNITY NOTIFICATIONS
  # ==========================================================================
  notify-community:
    name: Community Notifications
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Notify Discord
        run: |
          # Send notification to Discord channel
          curl -X POST \
            -H 'Content-type: application/json' \
            --data '{
              "content": "üöÄ New release **0xSCADA ${{ github.ref_name }}** is now available!\n\nüì¶ Install: `npm install 0xscada@${{ github.ref_name }}`\nüê≥ Docker: `docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}`\n\nüîó [Release Notes](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})"
            }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || true

      - name: Notify Twitter/X
        run: |
          # Post to Twitter/X
          echo "üöÄ New release 0xSCADA ${{ github.ref_name }} is now available!\n\nüì¶ Install: npm install 0xscada@${{ github.ref_name }}\nüê≥ Docker: docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}\n\n#0xSCADA #SCADA #IndustrialAutomation" || true

      - name: Update project README stats
        run: |
          # Update README with latest release info
          echo "Updating README with latest release info..."
          # Add README update logic here

  # ==========================================================================
  # CONTRIBUTOR RECOGNITION
  # ==========================================================================
  contributors:
    name: Update Contributors
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update contributors list
        run: |
          # Generate contributors list
          npx all-contributors check || true
          npx all-contributors generate || true
          
          # Commit and push changes
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .all-contributorsrc README.md || exit 0
          git commit -m "docs: update contributors" || exit 0
          git push || true

  # ==========================================================================
  # ISSUE AUTOMATION
  # ==========================================================================
  issue-automation:
    name: Issue Automation
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Close stale issues
        uses: actions/stale@v8
        with:
          stale-issue-message: 'This issue has been inactive for 30 days. It will be closed in 7 days if there is no further activity.'
          stale-pr-message: 'This pull request has been inactive for 30 days. It will be closed in 7 days if there is no further activity.'
          days-before-stale: 30
          days-before-close: 7

      - name: Welcome new contributors
        uses: actions/github-script@v6
        with:
          script: |
            // Add welcome message for new contributors
            // This would be implemented based on your needs
